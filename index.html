<!DOCTYPE html>
<html>
<head>
  <title>Fix Miami</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <link href="styles.css" rel="stylesheet" type="text/css" media="all">
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
  <script src="jquery.js"></script>
  <script>




  var incidents = (typeof localStorage['incidents'] !== "undefined" ) ?
  JSON.parse(localStorage['incidents']) : [];


  var Incident = function(type, latLon) {
    this.id = incidents.length;
    this.type = type;
    this.votes = 0;
    // gmaps obj
    this.loc = latLon;


    this.addVote = function() {
      this.votes += 1;
    }
    this.getVerbage = function(){
      return makeVerbage(type).append('Total Votes:',
        $('<span>', { text: this.votes }),
        $('<button>').text('Yes'),
        'No'
        );
    }

    this.save = function(){
      localStorage['incidents'] = JSON.stringify(incidents);
      console.log('Saved', incidents);
    }
    this.addIcon = function(){
      console.log("addIcon", this.type, this.loc);
      latLng = new google.maps.LatLng( this.loc.d, this.loc.e );
      var newIcon = new google.maps.Marker({
        position : latLng,
        map: map,
        animation: google.maps.Animation.DROP,
        icon:  icons[type].url,
        title: icons[type].title
      });

      //content for new icon
      google.maps.event.addListener( newIcon, 'click', function handleIconView(){
        var infowindow = new google.maps.InfoWindow({
          content: this.getVerbage()[0],
          position: latLng
        });
        infowindow.open(map);
        $('.verbage button').on('click', function() {
          this.addVote();
          $(this).prev('span').text( function( i, t ){ return parseInt(t) + 1; });
          this.save();
        });
      });
    }

    incidents.push(this);
    return this;
  }

  var map;


  var iconNames = [ 'crime', 'dirty', 'drunk', 'flooding', 'potholes', 'sewer', 'smelly', 'streetlight', 'traffic', 'trafficlight', 'transportation', 'trash', 'violence', 'beach', 'building', 'homeless', 'palmtree', 'park', 'party' ];

  var icons = {};

  for ( i in iconNames ){
    icons[iconNames[i]] = {
      url: 'images/' + iconNames[i] + '.png',
      value: iconNames[i],
      title: iconNames[i],
      verbage: 'test'
    }
  }

  function makeIconList() {
    var iconsHTML = $('<div>').addClass('iconList')
    for ( i in icons ){
      var icon = $('<span>').attr('data-type', icons[i].value)
      .append(
        $('<img>').attr('src', icons[i].url),
        icons[i].title
        );
      iconsHTML.append( icon );
    }
    return iconsHTML;
  }

  function makeVerbage(type){
    return $('<div>', { class : 'verbage', text: icons[type].verbage });
  }

  function restoreIcons(){
      // parse existing, rebuild
      if (incidents.length > 0){
        console.log('Local:', incidents);
        for (var i = 0, l = incidents.length; i < l; i++){
          console.log( incidents[i] );
          incidents[i] = new Incident( incidents[i].type, incidents[i].loc );
          incidents[i].addIcon();
        }
      }

    }

    function success(latLng){
      console.log('maps success');
      var lat = latLng.coords.latitude;
      var lon = latLng.coords.longitude;
      var latLon =  new google.maps.LatLng( lat, lon );

      console.log( lat, lon );

      var mapOptions = {
        zoom: 15,
        center:latLon
      };

      map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);

    // restore
    restoreIcons();
    //

    var poop = new google.maps.Marker({
      position : latLon,
      map: map,
      animation: google.maps.Animation.DROP,
      icon:  icons.drunk.url,
      title: icons.drunk.title
    });

    var infowindow = new google.maps.InfoWindow({
      content: "<div>A little man is a little drunk</div>"
    });

    google.maps.event.addListener(poop, 'click', function() {
      infowindow.open(map,poop);
    });


    function handleAddIconClick( e ){
      var content = makeIconList();
      var loc = e.latLng;
      var info = new google.maps.InfoWindow({
        content: content[0],
        position: loc
      });
      info.open(map);

      $('.iconList span').on('click', function(){
        console.log('click', $(this).attr('data-type'));
        var type = $(this).attr('data-type');

        var incident = new Incident( type, loc );
        incident.addIcon();

        info.close();
      });
    }

    //add new incident to map
    google.maps.event.addListener(map, 'click', handleAddIconClick );
  }

  // incidents
  // Votes
  // Browser Storage + Votes
  // Icon Objects + Verbage
  // TODO: Twitter Integration
  // TODO: Paypal Integration

  function error(){
    console.error("I can't handle this");
  }

  function initialize() {
    console.log('maps init');
    var options = {
      enableHighAccuracy: true,
      timeout: 5000,
      maximumAge: 0
    };

    navigator.geolocation.getCurrentPosition(success, error, options);
  }

  google.maps.event.addDomListener(window, 'load', initialize);

  function r() {
    localStorage.clear('incidents');
  }
  </script>
</head>
<body>
  <div id="map-canvas"></div>
  <div id="overlay">
    <h1>Help Us #fixMiami</h1>
  </div>
</body>
</html>
